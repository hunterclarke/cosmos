#!/bin/bash
#
# Build GPUI Orion with embedded OAuth credentials
#
# This script builds a release binary with credentials embedded at compile time,
# so the final binary doesn't require any external credential files.
#
# Usage:
#   ./script/build-gpui-release
#
# Prerequisites:
#   Run ./script/setup-credentials first

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

CREDENTIALS_FILE="$PROJECT_DIR/secrets/google-credentials.json"

# Check if credentials file exists
if [ ! -f "$CREDENTIALS_FILE" ]; then
    echo "Error: $CREDENTIALS_FILE not found"
    echo ""
    echo "Run ./script/setup-credentials first"
    exit 1
fi

# Extract client_id and client_secret from JSON
CLIENT_ID=$(cat "$CREDENTIALS_FILE" | python3 -c "
import json, sys
data = json.load(sys.stdin)
creds = data.get('installed') or data.get('web') or {}
print(creds.get('client_id', ''))
")

CLIENT_SECRET=$(cat "$CREDENTIALS_FILE" | python3 -c "
import json, sys
data = json.load(sys.stdin)
creds = data.get('installed') or data.get('web') or {}
print(creds.get('client_secret', ''))
")

if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
    echo "Error: Could not extract credentials from $CREDENTIALS_FILE"
    exit 1
fi

echo "Building GPUI Orion release with embedded credentials..."
echo "Client ID: ${CLIENT_ID:0:20}..."

GOOGLE_CLIENT_ID="$CLIENT_ID" \
GOOGLE_CLIENT_SECRET="$CLIENT_SECRET" \
cargo build -p orion --release

echo ""
echo "Build complete!"
echo "Binary: target/release/orion"
