#!/bin/bash
#
# Setup OAuth credentials for Orion apps
#
# This script reads secrets/google-credentials.json and:
# 1. Generates apple/Orion/Config/Secrets.xcconfig for SwiftUI builds
# 2. Creates symlink for GPUI app at ~/Library/Application Support/cosmos/
#
# Usage:
#   ./script/setup-credentials
#
# Prerequisites:
#   1. Copy secrets/google-credentials.json.template to secrets/google-credentials.json
#   2. Fill in your OAuth credentials from https://console.cloud.google.com

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

CREDENTIALS_FILE="$PROJECT_DIR/secrets/google-credentials.json"
XCCONFIG_FILE="$PROJECT_DIR/apple/Orion/Config/Secrets.xcconfig"
GPUI_CONFIG_DIR="$HOME/Library/Application Support/cosmos"

echo "Setting up OAuth credentials..."

# Check if credentials file exists
if [ ! -f "$CREDENTIALS_FILE" ]; then
    echo "Error: $CREDENTIALS_FILE not found"
    echo ""
    echo "Please create it by copying the template:"
    echo "  cp secrets/google-credentials.json.template secrets/google-credentials.json"
    echo ""
    echo "Then fill in your OAuth credentials from https://console.cloud.google.com"
    exit 1
fi

# Extract client_id and client_secret from JSON
# Try "installed" first, then "web"
CLIENT_ID=$(cat "$CREDENTIALS_FILE" | python3 -c "
import json, sys
data = json.load(sys.stdin)
creds = data.get('installed') or data.get('web') or {}
print(creds.get('client_id', ''))
")

CLIENT_SECRET=$(cat "$CREDENTIALS_FILE" | python3 -c "
import json, sys
data = json.load(sys.stdin)
creds = data.get('installed') or data.get('web') or {}
print(creds.get('client_secret', ''))
")

if [ -z "$CLIENT_ID" ] || [ -z "$CLIENT_SECRET" ]; then
    echo "Error: Could not extract client_id or client_secret from $CREDENTIALS_FILE"
    echo "Make sure the file has an 'installed' or 'web' section with credentials."
    exit 1
fi

echo "Found credentials for: ${CLIENT_ID:0:20}..."

# Generate Secrets.xcconfig for SwiftUI
echo "Generating $XCCONFIG_FILE..."
mkdir -p "$(dirname "$XCCONFIG_FILE")"
cat > "$XCCONFIG_FILE" << EOF
// Auto-generated by script/setup-credentials
// Do not edit manually - update secrets/google-credentials.json instead

GOOGLE_CLIENT_ID = $CLIENT_ID
GOOGLE_CLIENT_SECRET = $CLIENT_SECRET
EOF
echo "  Created Secrets.xcconfig"

# Setup for GPUI app - create symlink or copy
echo "Setting up GPUI credentials..."
mkdir -p "$GPUI_CONFIG_DIR"

GPUI_CREDENTIALS="$GPUI_CONFIG_DIR/google-credentials.json"
if [ -L "$GPUI_CREDENTIALS" ]; then
    # Remove existing symlink
    rm "$GPUI_CREDENTIALS"
fi

if [ -f "$GPUI_CREDENTIALS" ] && [ ! -L "$GPUI_CREDENTIALS" ]; then
    echo "  Note: Existing credentials file at $GPUI_CREDENTIALS"
    echo "  Creating backup at ${GPUI_CREDENTIALS}.backup"
    mv "$GPUI_CREDENTIALS" "${GPUI_CREDENTIALS}.backup"
fi

ln -s "$CREDENTIALS_FILE" "$GPUI_CREDENTIALS"
echo "  Created symlink: $GPUI_CREDENTIALS -> $CREDENTIALS_FILE"

echo ""
echo "Setup complete!"
echo ""
echo "Development:"
echo "  - Build SwiftUI Orion: ./script/run-swiftui-macos"
echo "  - Run GPUI Orion: cargo run -p orion"
echo ""
echo "Production builds (credentials embedded at compile time):"
echo "  GOOGLE_CLIENT_ID='$CLIENT_ID' \\"
echo "  GOOGLE_CLIENT_SECRET='$CLIENT_SECRET' \\"
echo "  cargo build -p orion --release"
